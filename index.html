<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Billionaires 2023: Wealth and Tax Policies Worldwide</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
      rel="stylesheet"
    />

    <style>
      html {
        overflow-x: hidden;
      }
      * {
        font-family: "sans-serif";
        font-weight: 300;
        margin: 10px;
        background-color: #fefefe;
        color: #465562;
      }

      .ubuntu-medium {
        font-family: "Ubuntu", sans-serif;
        font-weight: 500;
        font-style: normal;
      }

      h1 {
        font-weight: 800;
        font-family: "Noto Sans";
        font-size: 40px;
        margin-top: 10px;
        color: #465562;
      }

      h3 {
        font-weight: 800;
        font-family: "Noto Sans";
        font-size: 16px;
        margin-top: 10px;
        color: #465562;
      }

      .bubble {
        stroke: #fff;
        stroke-width: 1px;
      }
      .tooltip {
        position: absolute;
        background-color: rgb(55, 55, 55);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        visibility: hidden;
      }

      .legend text {
        font-size: 14px;
      }

      .axis line {
        display: none;
      }

      .axis text {
        font-size: 13px;
        color: #465562;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .axis line {
        display: none;
      }

      .grid line {
        stroke: lightgrey;
        stroke-opacity: 0.7;
        shape-rendering: crispEdges;
      }
      .grid path {
        stroke-width: 0;
      }

      .reference {
        font-size: 12px;
      }

      .desc {
        max-width: 70vw;
      }
    </style>
  </head>

  <body>
    <h1 class="ubuntu-medium">
      Global Wealth Map 2023: Billionaires, Taxes, and Population
    </h1>
    <div class="desc">
      The purpose of this visualization is to explore and analyze the
      relationship between billionaires' wealth accumulation, tax policies, and
      population size in different countries around the world.
    </div>
    <div id="chart"></div>
    <div class="tooltip"></div>
    <div class="reference">
      <h3>References</h3>

      <p>
        [1] Javier_SAB. (2024, February 24).
        <a
          href="Billionaires dataset cleaned. Kaggle. https://www.kaggle.com/datasets/javiersab/billionaires-dataset-cleaned/data "
          >Billionaires dataset cleaned. Kaggle.
          https://www.kaggle.com/datasets/javiersab/billionaires-dataset-cleaned/data
        </a>
      </p>
      <p>
        [2] Rosling, H. (n.d.). World Health Chart. Gapminder.<a
          href="https://www.gapminder.org/fw/world-health-chart/"
          >https://www.gapminder.org/fw/world-health-chart/</a
        >
      </p>
    </div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      ;(async () => {
        let finalData
        const rawData = await d3.csv("./data/df_ready.csv")
        const data = rawData.filter(
          (d) => +d.tax_rate <= 100 && +d.tax_rate > 0
        )
        const processedData = data.reduce((accumulator, current) => {
          let {
            country_of_residence,
            wealth,
            life_expectancy,
            age,
            country_pop,
            continent,
            tax_rate,
          } = current
          wealth = +wealth
          country_pop = +country_pop
          age = +age
          tax_rate = +tax_rate

          if (!accumulator[country_of_residence]) {
            accumulator[country_of_residence] = {
              country: country_of_residence,
              total_wealth: 0,
              average_life_expectancy: life_expectancy,
              population: country_pop,
              continent: continent,
              billionaires: 0,
              tax_rate,
            }
          }

          accumulator[country_of_residence].total_wealth += wealth
          accumulator[country_of_residence].billionaires += 1

          return accumulator
        }, {})
        finalData = Object.values(processedData)

        // svg size
        var svgWidth = 1000,
          svgHeight = 550
        var margin = { top: 18, right: 170, bottom: 90, left: 60 }
        var width = svgWidth - margin.left - margin.right
        var height = svgHeight - margin.top - margin.bottom

        var svg = d3
          .select("#chart")
          .append("svg")
          .attr("width", svgWidth)
          .attr("height", svgHeight)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          )

        // title
        svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", -20)
          .attr("text-anchor", "middle")
          .style("font-size", "24px")
          .text("Global Wealth and Life Expectancy")

        svg
          .append("text")
          .attr(
            "transform",
            "translate(" + (width - 100) + "," + (height / 2 + 200) + ") "
          )
          .attr("text-anchor", "middle")
          .style("font-size", "1.8vw")
          .text("Size: Population")
          .style("fill", "#c7ccd0")

        var xTitle = svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", height + margin.bottom - 40)
          .style("text-anchor", "middle")
          .style("font-size", "16px")
          .style("color", "#383e40")
          .text("Total wealth of billionaries (billion US dollars)")

        var yTitle = svg
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 0 - margin.left)
          .attr("x", 0 - height / 2)
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .style("font-size", "16px")
          .style("color", "#383e40")
          .text("Tax Rate (%)")

        const customTickValues = [
          31250, 62500, 125000, 250000, 500000, 1000000, 2000000, 4000000,
          8000000,
        ]
        // x axis
        var x = d3
          .scaleSqrt()
          .domain([
            0,
            d3.max(finalData, function (d) {
              return d.total_wealth
            }),
          ])
          .range([0, width])
          .nice()

        // y axis
        var y = d3
          .scaleLinear()
          .domain([0, d3.max(finalData, (d) => d.tax_rate)])
          .range([height, 0])

        svg
          .append("g")
          .attr("class", "axis")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x).tickFormat((d) => `${d / 1000}`))

        svg.append("g").attr("class", "axis").call(d3.axisLeft(y).ticks(10))

        // grid line
        svg
          .append("g")
          .attr("class", "grid")
          .call(d3.axisLeft(y).tickSize(-width).tickFormat(""))
          .selectAll("line")
          .style("stroke", "lightgrey")
          .style("stroke-opacity", "0.5")

        svg
          .append("g")
          .attr("class", "grid")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x).tickSize(-height).tickFormat(""))
          .selectAll("line")
          .style("stroke", "lightgrey")
          .style("stroke-opacity", "0.4")

        // bubble size
        var z = d3
          .scaleSqrt()
          .domain([
            0,
            d3.max(finalData, function (d) {
              return d.population
            }),
          ])
          .range([8, 60])

        // bubble color
        var color = d3
          .scaleOrdinal(d3.schemeCategory10)
          .domain(finalData.map((d) => d.continent))

        // legend
        var legendPosition = { x: width + 40, y: height - 200 }

        // add legend to page
        var legend = svg
          .selectAll(".legend")
          .data(color.domain()) // color range
          .enter()
          .append("g")
          .attr("class", "legend")
          .attr("transform", function (d, i) {
            return "translate(0," + i * 5 + ")"
          }) // vertical position of each legend item

        // draw color circle for each legend
        legend
          .append("circle")
          .attr("cx", legendPosition.x)
          .attr("cy", function (d, i) {
            return legendPosition.y + i * 25
          })
          .attr("r", 10)
          .style("fill", color)
          .style("opacity", 0.7)

        // legend text
        legend
          .append("text")
          .attr("x", legendPosition.x + 20)
          .attr("y", function (d, i) {
            return legendPosition.y + i * 25
          })
          .text(function (d) {
            return d
          })
          .style("text-anchor", "start")
          .style("alignment-baseline", "middle")
          .style("color", "#495561")

        // hover and filter
        legend
          .on("mouseover", function (event, selectedContinent) {
            svg.selectAll(".bubble").style("opacity", function (d) {
              return d.continent === selectedContinent ? 0.7 : 0.1
            })

            svg
              .selectAll(".bubble")
              .filter((d) => d.continent === selectedContinent)
              .raise()

            svg
              .selectAll(".legend circle")
              .filter(function (d) {
                return d === selectedContinent
              })
              .transition()
              .duration(200)
              .attr("r", 12) // Increase radius
          })
          .on("mouseout", function (event, selectedContinent) {
            svg.selectAll(".bubble").style("opacity", 0.7)

            svg
              .selectAll(".legend circle")
              .filter(function (d) {
                return d === selectedContinent
              })
              .transition()
              .duration(200)
              .attr("r", 10) // Return to original radius
          })
          .style("cursor", "pointer")

        // draw bubbles
        svg
          .selectAll(".bubble")
          .data(finalData)
          .enter()
          .append("circle")
          .attr("class", "bubble")
          .attr("cx", function (d) {
            return x(d.total_wealth)
          })
          .attr("cy", function (d) {
            return y(d.tax_rate)
          })
          .attr("r", function (d) {
            return z(d.population)
          })
          .style("fill", function (d) {
            return color(d.continent)
          })
          .style("opacity", 0.7)

        // hover and show tooltip
        var tooltip = d3.select(".tooltip")
        svg
          .selectAll(".bubble")
          .on("mouseover", function (event, d) {
            tooltip
              .style("visibility", "visible")
              .html(
                d.country +
                  "<br/>Population: " +
                  (d.population / 1e6).toFixed(2) +
                  " million" +
                  "<br/>Billionaires Number: " +
                  d.billionaires +
                  "<br/>Total Wealth: " +
                  d.total_wealth / 1000 +
                  " billion" +
                  "<br/>Tax Rate: " +
                  d.tax_rate +
                  "%"
              )

            d3.selectAll(".bubble").style("opacity", 0.1)
            d3.select(this).style("opacity", 0.7)

            d3.select(this).style("cursor", "pointer")
          })
          .on("mousemove", function (event, d) {
            tooltip
              .style("top", event.pageY - 10 + "px")
              .style("left", event.pageX + 10 + "px")
          })
          .on("mouseout", function () {
            tooltip.style("visibility", "hidden")
            d3.selectAll(".bubble").style("opacity", 0.7)
            d3.select(this).style("cursor", "default")
          })
      })()
    </script>
  </body>
</html>
