<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wealth, Gender and Age</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
      rel="stylesheet"
    />

    <style>
      html {
        overflow-x: hidden;
      }
      * {
        font-family: "sans-serif";
        font-weight: 300;
        margin: 10px;
        background-color: #fefefe;
        color: #465562;
      }

      .ubuntu-medium {
        font-family: "Ubuntu", sans-serif;
        font-weight: 500;
        font-style: normal;
      }

      h1 {
        font-weight: 800;
        font-family: "Noto Sans";
        font-size: 40px;
        margin-top: 10px;
        color: #465562;
      }

      h3 {
        font-weight: 800;
        font-family: "Noto Sans";
        font-size: 16px;
        margin-top: 10px;
        color: #465562;
      }

      .bubble {
        stroke: #fff;
        stroke-width: 1px;
      }
      .tooltip {
        position: absolute;
        background-color: rgb(55, 55, 55);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        visibility: hidden;
      }

      .legend text {
        font-size: 12px;
      }

      .axis line {
        display: none;
      }

      .axis text {
        font-size: 13px;
        color: #465562;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .axis line {
        display: none;
      }

      .grid line {
        stroke: lightgrey;
        stroke-opacity: 0.7;
        shape-rendering: crispEdges;
      }
      .grid path {
        stroke-width: 0;
      }

      .reference {
        font-size: 12px;
      }

      .desc {
        max-width: 70vw;
      }
    </style>
  </head>

  <body>
    <h1 class="ubuntu-medium">
      Billionaires and Borders: Tracing the Wealth and Tax Policies Worldwide
    </h1>
    <div class="desc">
      This interactive tool delves deep into the realms of global finance,
      showcasing the cumulative wealth of billionaires in each country plotted
      against the backdrop of national tax rates.
    </div>
    <div id="chart"></div>
    <div class="tooltip"></div>
    <div class="reference">
      <h3>References</h3>
      <p>
        [1] Elgiriyewithana, N. (2023, September 29). Billionaires statistics
        dataset (2023). Kaggle.<a
          href="https://www.gapminder.org/fw/world-health-chart/"
          >https://www.kaggle.com/datasets/nelgiriyewithana/billionaires-statistics-dataset</a
        >
      </p>
      <p>
        [2] Javier_SAB. (2024, February 24).
        <a
          href="Billionaires dataset cleaned. Kaggle. https://www.kaggle.com/datasets/javiersab/billionaires-dataset-cleaned/data "
          >Billionaires dataset cleaned. Kaggle.
          https://www.kaggle.com/datasets/javiersab/billionaires-dataset-cleaned/data
        </a>
      </p>
      <p>
        [3] Rosling, H. (n.d.). World Health Chart. Gapminder.<a
          href="https://www.gapminder.org/fw/world-health-chart/"
          >https://www.gapminder.org/fw/world-health-chart/</a
        >
      </p>
    </div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      ;(async () => {
        let finalData
        const data = await d3.csv("/data/df_ready.csv")
        console.log(data)
        const processedData = data.reduce((accumulator, current) => {
          let {
            country_of_residence,
            wealth,
            life_expectancy,
            age,
            country_pop,
            continent,
            tax_rate,
          } = current
          wealth = +wealth // 将字符串转换为数字
          country_pop = +country_pop // 转换为数字
          age = +age // 确保年龄是数字类型
          tax_rate = +tax_rate

          // 如果这个国家还没有被加入到累加器中，添加它
          if (!accumulator[country_of_residence]) {
            accumulator[country_of_residence] = {
              country: country_of_residence,
              total_wealth: 0,
              average_life_expectancy: life_expectancy,
              population: country_pop,
              continent: continent,
              billionaires: 0,
              tax_rate,
            }
          }

          // 累加财富和亿万富翁人数
          accumulator[country_of_residence].total_wealth += wealth
          accumulator[country_of_residence].billionaires += 1

          return accumulator
        }, {})
        finalData = Object.values(processedData)

        console.log("finalData", finalData)

        // 画布大小
        var svgWidth = window.innerWidth * 0.55,
          svgHeight = window.innerHeight * 0.6
        var margin = { top: 15, right: 170, bottom: 90, left: 60 }
        var width = svgWidth - margin.left - margin.right
        var height = svgHeight - margin.top - margin.bottom

        // 把矢量图放到页面上
        var svg = d3
          .select("#chart")
          .append("svg")
          .attr("width", svgWidth)
          .attr("height", svgHeight)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          )

        // 添加图表标题
        svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", -20) // 根据需要调整y坐标，以确保标题不超出画布
          .attr("text-anchor", "middle")
          .style("font-size", "24px") // 调整字体大小
          .text("Global Wealth and Life Expectancy") // 更改为您的标题

        // // 添加图表背景
        // svg
        //   .append("rect")
        //   .attr("x", 0)
        //   .attr("y", 0) // 根据需要调整位置
        //   .attr("width", width)
        //   .attr("height", height) // 根据需要调整高度
        //   .style("fill", "#fefefe") // 调整背景颜色

        // Adding text to the background
        svg
          .append("text")
          .attr(
            "transform",
            "translate(" +
              (width - 10) +
              "," +
              (height / 2 - 80) +
              ") rotate(-90)"
          )
          .attr("text-anchor", "middle")
          .style("font-size", "1.8vw")
          .text("Size: Population")
          .style("fill", "#c7ccd0")
          .style("opacity", "0.6")

        // x轴标题
        var xTitle = svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", height + margin.bottom - 40)
          .style("text-anchor", "middle")
          .style("font-size", "16px") // 调整字体大小
          .style("color", "#383e40")
          .text("Total wealth of billionaries (billion US dollars)")

        // y轴标题
        var yTitle = svg
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 0 - margin.left)
          .attr("x", 0 - height / 2)
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .style("font-size", "16px")
          .style("color", "#383e40")
          .text("Tax Rate (%)")

        const customTickValues = [
          31250, 62500, 125000, 250000, 500000, 1000000, 2000000, 4000000,
          8000000,
        ]
        // x轴
        var x = d3
          .scaleSqrt()
          .domain([
            0,
            d3.max(finalData, function (d) {
              return d.total_wealth
            }),
          ])
          .range([0, width])
          .nice()

        var y = d3
          .scaleLinear()
          .domain([0, d3.max(finalData, (d) => d.tax_rate)]) // 假设税率是从 0 到最大值
          .range([height, 0])
        // 添加X轴
        svg
          .append("g")
          .attr("class", "axis")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x).tickFormat((d) => `${d / 10000}`))

        // 添加y轴
        svg.append("g").attr("class", "axis").call(d3.axisLeft(y).ticks(10))

        // Y轴网格线
        svg
          .append("g")
          .attr("class", "grid")
          .call(d3.axisLeft(y).tickSize(-width).tickFormat(""))
          .selectAll("line")
          .style("stroke", "lightgrey")
          .style("stroke-opacity", "0.5")

        // X轴网格线
        svg
          .append("g")
          .attr("class", "grid")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x).tickSize(-height).tickFormat(""))
          .selectAll("line")
          .style("stroke", "lightgrey")
          .style("stroke-opacity", "0.4")

        // bubble size
        var z = d3
          .scaleSqrt()
          .domain([
            0,
            d3.max(finalData, function (d) {
              return d.population
            }),
          ])
          .range([6, 40])
        // bubble color
        var color = d3
          .scaleOrdinal(d3.schemeCategory10)
          .domain(finalData.map((d) => d.continent))

        // 图例
        var legendPosition = { x: width + 40, y: height - 200 }
        // 添加图例
        var legend = svg
          .selectAll(".legend")
          .data(color.domain()) // 使用颜色比例尺的域
          .enter()
          .append("g")
          .attr("class", "legend")
          .attr("transform", function (d, i) {
            return "translate(0," + i * 5 + ")"
          }) // 每个图例项的垂直位置

        // 绘制图例的颜色块
        legend
          .append("circle")
          .attr("cx", legendPosition.x)
          .attr("cy", function (d, i) {
            return legendPosition.y + i * 25
          }) // 根据图例项的索引和位置调整
          .attr("r", 10)
          .style("fill", color)
          .style("fill-opacity", 0.8)

        // 绘制图例的文本
        legend
          .append("text")
          .attr("x", legendPosition.x + 20)
          .attr("y", function (d, i) {
            return legendPosition.y + i * 25
          })
          .text(function (d) {
            return d
          })
          .style("text-anchor", "start")
          .style("alignment-baseline", "middle")
          .style("color", "#495561")

        // 图例交互 - 悬浮筛选
        legend
          .on("mouseover", function (event, selectedContinent) {
            svg.selectAll(".bubble").style("fill-opacity", function (d) {
              return d.continent === selectedContinent ? 0.8 : 0.1
            })

            // 将选中大洲的气泡移动到顶层
            svg
              .selectAll(".bubble")
              .filter((d) => d.continent === selectedContinent)
              .raise() // 将符合条件的元素移动到其父元素的末尾，使其在顶层显示
          })
          .on("mouseout", function (event, selectedContinent) {
            svg.selectAll(".bubble").style("fill-opacity", 0.8)
          })
          .style("cursor", "pointer")

        // 在图例上方添加Bubble Size说明
        svg
          .append("text")
          .attr("x", legendPosition.x - 22)
          .attr("y", legendPosition.y - 30) // 根据需要调整位置
          .text("Bubble Size: Population") // 文本内容
          .style("font-size", "12px") // 调整字体大小
          .style("color", "#495561") // 调整字体颜色

        // 把bubble放到图表上
        svg
          .selectAll(".bubble")
          .data(finalData)
          .enter()
          .append("circle")
          .attr("class", "bubble")
          .attr("cx", function (d) {
            return x(d.total_wealth)
          })
          .attr("cy", function (d) {
            return y(d.tax_rate)
          })
          .attr("r", function (d) {
            return z(d.population)
          })
          .style("fill", function (d) {
            return color(d.continent)
          })
          .style("fill-opacity", 0.7)

        // 添加悬浮提示
        var tooltip = d3.select(".tooltip")
        svg
          .selectAll(".bubble")
          .on("mouseover", function (event, d) {
            tooltip
              .style("visibility", "visible")
              .html(
                d.country +
                  "<br/>Population: " +
                  (d.population / 1e6).toFixed(2) +
                  " million" +
                  " <br/>Billionaires Number: " +
                  d.billionaires +
                  "<br/>Total Wealth: " +
                  d.total_wealth / 1000 +
                  " billion" +
                  "<br/>Tax Rate: " +
                  d.tax_rate +
                  "%"
              )

            // 当鼠标悬浮在一个气泡上时，将这个气泡的透明度设为0.8，并将其他所有气泡的透明度设为0.1
            d3.selectAll(".bubble").style("opacity", 0.1) // 首先将所有气泡的透明度设置为0.1
            d3.select(this).style("opacity", 0.8) // 然后将当前气泡的透明度设置为0.8

            // 修改鼠标指针为手形
            d3.select(this).style("cursor", "pointer")
          })
          .on("mousemove", function (event, d) {
            tooltip
              .style("top", event.pageY - 10 + "px")
              .style("left", event.pageX + 10 + "px")
          })
          .on("mouseout", function () {
            tooltip.style("visibility", "hidden")
            // 当鼠标移出气泡时，恢复所有气泡的透明度为0.7
            d3.selectAll(".bubble").style("opacity", 0.8)

            // 恢复鼠标指针为默认形状
            d3.select(this).style("cursor", "default")
          })
      })()
    </script>
  </body>
</html>
