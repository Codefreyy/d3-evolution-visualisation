<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wealth, Gender and Age</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
      rel="stylesheet"
    />

    <style>
      html {
        overflow: hidden;
      }
      * {
        font-family: "sans-serif";
        font-weight: 300;
        margin: 10px;
        background-color: #fefefe;
      }

      .ubuntu-medium {
        font-family: "Ubuntu", sans-serif;
        font-weight: 500;
        font-style: normal;
      }

      h3 {
        font-weight: 800;
        font-family: "Noto Sans";
        font-size: 40px;
        margin-top: 10px;
      }

      #chart {
        margin: 50px 0px;
      }

      .bubble {
        stroke: #fff;
        stroke-width: 1px;
      }
      .tooltip {
        position: absolute;
        background-color: rgb(55, 55, 55);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        visibility: hidden;
      }

      .axis line {
        display: none;
      }

      .axis text {
        font-size: 13px;
        color: #465562;
      }

      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .axis line {
        display: none;
      }

      .grid line {
        stroke: lightgrey;
        stroke-opacity: 0.7;
        shape-rendering: crispEdges;
      }
      .grid path {
        stroke-width: 0;
      }
    </style>
  </head>

  <body>
    <h3 class="ubuntu-medium">Wealth, Longevity, and Generational Shifts</h3>
    <div id="chart"></div>
    <div class="tooltip"></div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      ;(async () => {
        let finalData
        const data = await d3.csv("/data/df_ready.csv")
        const processedData = data.reduce((accumulator, current) => {
          let {
            country_of_residence,
            wealth,
            life_expectancy,
            age,
            country_pop,
            continent,
          } = current
          wealth = +wealth // 将字符串转换为数字
          country_pop = +country_pop // 转换为数字
          age = +age // 确保年龄是数字类型

          // 如果这个国家还没有被加入到累加器中，添加它
          if (!accumulator[country_of_residence]) {
            accumulator[country_of_residence] = {
              country: country_of_residence,
              total_wealth: 0,
              total_age: 0, // 新增：总年龄
              average_age: 0, // 新增：平均年龄
              average_life_expectancy: life_expectancy,
              population: country_pop,
              continent: continent,
              billionaires: 0,
            }
          }

          // 累加财富和亿万富翁人数
          accumulator[country_of_residence].total_wealth += wealth
          accumulator[country_of_residence].total_age += age // 累加年龄
          accumulator[country_of_residence].billionaires += 1
          accumulator[country_of_residence].average_age =
            accumulator[country_of_residence].total_age /
            accumulator[country_of_residence].billionaires // 计算平均年龄

          return accumulator
        }, {})
        finalData = Object.values(processedData)

        console.log("finalData", finalData)

        // 画布大小
        var svgWidth = 900,
          svgHeight = 600
        var margin = { top: 40, right: 200, bottom: 100, left: 60 }
        var width = svgWidth - margin.left - margin.right
        var height = svgHeight - margin.top - margin.bottom

        // 把矢量图放到页面上
        var svg = d3
          .select("#chart")
          .append("svg")
          .attr("width", svgWidth)
          .attr("height", svgHeight)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          )

        // 添加图表标题
        svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", -20) // 根据需要调整y坐标，以确保标题不超出画布
          .attr("text-anchor", "middle")
          .style("font-size", "24px") // 调整字体大小
          .text("Global Wealth and Life Expectancy") // 更改为您的标题

        // // 添加图表背景
        // svg
        //   .append("rect")
        //   .attr("x", 0)
        //   .attr("y", 0) // 根据需要调整位置
        //   .attr("width", width)
        //   .attr("height", height) // 根据需要调整高度
        //   .style("fill", "#fff") // 调整背景颜色

        // x轴标题
        var xTitle = svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", height + margin.bottom - 40)
          .style("text-anchor", "middle")
          .style("font-size", "16px") // 调整字体大小
          .style("color", "#383e40")
          .text("Total wealth of billionaries (US dollars trillion)")

        // y轴标题
        var yTitle = svg
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 0 - margin.left)
          .attr("x", 0 - height / 2)
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .style("font-size", "16px")
          .style("color", "#383e40")
          .text("Average Age of Billionaires (Years)")

        const customTickValues = [
          31250, 62500, 125000, 250000, 500000, 1000000, 2000000, 4000000,
          8000000,
        ]
        // x轴
        var x = d3
          .scaleSqrt()
          .domain([
            0,
            d3.max(finalData, function (d) {
              return d.total_wealth
            }),
          ])
          .range([0, width])
          .nice()

        var y = d3
          .scaleLinear()
          .domain([
            d3.min(finalData, (d) => d.average_age), // 使用平均年龄的最小值作为Y轴的起点
            d3.max(finalData, (d) => d.average_age), // 使用平均年龄的最大值作为Y轴的终点
          ])
          .range([height, 0])
        // 添加X轴
        svg
          .append("g")
          .attr("class", "axis")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x).tickFormat((d) => `${d / 10000}`))

        // 添加y轴
        svg.append("g").attr("class", "axis").call(d3.axisLeft(y).ticks(10))

        // bubble size
        var z = d3
          .scaleSqrt()
          .domain([
            0,
            d3.max(finalData, function (d) {
              return d.population
            }),
          ])
          .range([6, 40])
        // bubble color
        var color = d3
          .scaleOrdinal(d3.schemeCategory10)
          .domain(finalData.map((d) => d.continent))

        // 图例
        var legendPosition = { x: width + 40, y: height - 200 }
        // 添加图例
        var legend = svg
          .selectAll(".legend")
          .data(color.domain()) // 使用颜色比例尺的域
          .enter()
          .append("g")
          .attr("class", "legend")
          .attr("transform", function (d, i) {
            return "translate(0," + i * 5 + ")"
          }) // 每个图例项的垂直位置

        // 绘制图例的颜色块
        legend
          .append("circle")
          .attr("cx", legendPosition.x)
          .attr("cy", function (d, i) {
            return legendPosition.y + i * 25
          }) // 根据图例项的索引和位置调整
          .attr("r", 10)
          .style("fill", color)
          .style("fill-opacity", 0.8)

        // 绘制图例的文本
        legend
          .append("text")
          .attr("x", legendPosition.x + 20)
          .attr("y", function (d, i) {
            return legendPosition.y + i * 25
          })
          .text(function (d) {
            return d
          })
          .style("text-anchor", "start")
          .style("alignment-baseline", "middle")
          .style("color", "#000000")

        // 图例交互 - 悬浮筛选
        legend
          .on("mouseover", function (event, selectedContinent) {
            svg.selectAll(".bubble").style("fill-opacity", function (d) {
              return d.continent === selectedContinent ? 0.8 : 0.1
            })

            // 将选中大洲的气泡移动到顶层
            svg
              .selectAll(".bubble")
              .filter((d) => d.continent === selectedContinent)
              .raise() // 将符合条件的元素移动到其父元素的末尾，使其在顶层显示
          })
          .on("mouseout", function (event, selectedContinent) {
            svg.selectAll(".bubble").style("fill-opacity", 0.8)
          })
          .style("cursor", "pointer")

        // 把bubble放到图表上
        svg
          .selectAll(".bubble")
          .data(finalData)
          .enter()
          .append("circle")
          .attr("class", "bubble")
          .attr("cx", function (d) {
            return x(d.total_wealth)
          })
          .attr("cy", function (d) {
            return y(d.average_life_expectancy)
          })
          .attr("r", function (d) {
            return z(d.population)
          })
          .style("fill", function (d) {
            return color(d.continent)
          })
          .style("fill-opacity", 0.7)

        // Y轴网格线
        svg
          .append("g")
          .attr("class", "grid")
          .call(d3.axisLeft(y).tickSize(-width).tickFormat(""))
          .selectAll("line")
          .style("stroke", "lightgrey")
          .style("stroke-opacity", "0.5")

        // X轴网格线
        svg
          .append("g")
          .attr("class", "grid")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x).tickSize(-height).tickFormat(""))
          .selectAll("line")
          .style("stroke", "lightgrey")
          .style("stroke-opacity", "0.4")

        // 添加悬浮提示
        var tooltip = d3.select(".tooltip")
        svg
          .selectAll(".bubble")
          .on("mouseover", function (event, d) {
            tooltip
              .style("visibility", "visible")
              .html(
                d.country +
                  " <br/>Billionaires Number: " +
                  d.billionaires +
                  "<br/>Total Wealth: " +
                  d.total_wealth / 10000 +
                  " trillion" +
                  "<br/>Population: " +
                  (d.population / 1e6).toFixed(2) +
                  " million"
              )

            // 当鼠标悬浮在一个气泡上时，将这个气泡的透明度设为0.8，并将其他所有气泡的透明度设为0.1
            d3.selectAll(".bubble").style("opacity", 0.1) // 首先将所有气泡的透明度设置为0.1
            d3.select(this).style("opacity", 0.8) // 然后将当前气泡的透明度设置为0.8

            // 修改鼠标指针为手形
            d3.select(this).style("cursor", "pointer")
          })
          .on("mousemove", function (event, d) {
            tooltip
              .style("top", event.pageY - 10 + "px")
              .style("left", event.pageX + 10 + "px")
          })
          .on("mouseout", function () {
            tooltip.style("visibility", "hidden")
            // 当鼠标移出气泡时，恢复所有气泡的透明度为0.7
            d3.selectAll(".bubble").style("opacity", 0.8)

            // 恢复鼠标指针为默认形状
            d3.select(this).style("cursor", "default")
          })
      })()
    </script>
  </body>
</html>
