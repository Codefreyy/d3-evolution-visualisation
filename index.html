<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Wealth, Gender and Age</title>
    <style>
      * {
        font-family: "Gill Sans", "Gill Sans MT", Calibri, "Trebuchet MS",
          sans-serif;
        font-weight: 500;
      }
      .bubble {
        stroke: #fff;
        stroke-width: 1.5px;
      }
      .tooltip {
        position: absolute;
        background-color: rgb(55, 55, 55);
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        visibility: hidden;
      }
      /* 添加一些样式来美化坐标轴 */
      .axis text {
        font: 10px sans-serif;
      }
      .axis path,
      .axis line {
        fill: none;
        stroke: #000;
        shape-rendering: crispEdges;
      }

      .grid line {
        stroke: lightgrey;
        stroke-opacity: 0.7;
        shape-rendering: crispEdges;
      }
      .grid path {
        stroke-width: 0;
      }
    </style>
  </head>

  <body>
    <div id="chart"></div>
    <div class="tooltip"></div>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      ;(async () => {
        let finalData
        const data = await d3.csv("/data/df_ready.csv")
        const processedData = data.reduce((accumulator, current) => {
          let {
            country_of_residence,
            wealth,
            life_expectancy,
            country_pop,
            continent,
          } = current
          wealth = +wealth // 将字符串转换为数字
          country_pop = +country_pop // 转换为数字

          // 如果这个国家还没有被加入到累加器中，添加它
          if (!accumulator[country_of_residence]) {
            accumulator[country_of_residence] = {
              country: country_of_residence,
              total_wealth: 0,
              average_life_expectancy: life_expectancy,
              population: country_pop,
              continent: continent,
              billionaires: 0,
            }
          }

          // 累加财富和亿万富翁人数
          accumulator[country_of_residence].total_wealth += wealth
          accumulator[country_of_residence].billionaires += 1

          return accumulator
        }, {})

        // 然后，从处理过的数据对象中提取值数组
        finalData = Object.values(processedData)
        console.log("fi", finalData)

        var svgWidth = 960,
          svgHeight = 600
        var margin = { top: 40, right: 40, bottom: 100, left: 60 }
        var width = svgWidth - margin.left - margin.right
        var height = svgHeight - margin.top - margin.bottom

        var svg = d3
          .select("#chart")
          .append("svg")
          .attr("width", svgWidth)
          .attr("height", svgHeight)
          .append("g")
          .attr(
            "transform",
            "translate(" + margin.left + "," + margin.top + ")"
          )

        svg
          .append("rect")
          .attr("x", 0)
          .attr("y", 0) // 根据需要调整位置
          .attr("width", width)
          .attr("height", height) // 根据需要调整高度
          .style("fill", "#fff") // 调整背景颜色

        // 修改X轴标题并添加问号
        var xTitle = svg
          .append("text")
          .attr("x", width / 2)
          .attr("y", height + margin.bottom - 20)
          .style("text-anchor", "middle")
          .style("font-size", "16px") // 调整字体大小
          .style("color", "#383e40")
          .text("Sum wealth of billions")

        xTitle
          .append("tspan")
          .attr("dx", "1em") // 问号与标题的距离
          .text("❓")
          .style("font-size", "16px") // 调整问号大小
          .style("cursor", "pointer") // 鼠标悬浮时变成手形
          .style("color", "383e40")
          .append("title") // 添加解释性文本
          .text("Total wealth in billions of dollars.")

        // 对Y轴标题进行相同的操作
        var yTitle = svg
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr("y", 0 - margin.left)
          .attr("x", 0 - height / 2)
          .attr("dy", "1em")
          .style("text-anchor", "middle")
          .style("font-size", "16px") // 调整字体大小
          .text("Life expectancy")

        yTitle
          .append("tspan")
          .attr("dx", "1em") // 问号与标题的距离
          .text("❓")
          .style("font-size", "16px") // 调整问号大小
          .style("cursor", "pointer") // 鼠标悬浮时变成手形
          .append("title") // 添加解释性文本
          .text("Average life expectancy at birth.")

        var x = d3
          .scaleLinear()
          .domain([
            1,
            d3.max(finalData, function (d) {
              return d.total_wealth
            }),
          ])
          .range([0, width])
          .nice()

        var y = d3.scaleLinear().domain([50, 90]).range([height, 0])

        var z = d3
          .scaleSqrt()
          .domain([
            0,
            d3.max(finalData, function (d) {
              return d.population
            }),
          ])
          .range([6, 40])

        var color = d3.scaleOrdinal(d3.schemeCategory10)

        svg
          .selectAll(".bubble")
          .data(finalData)
          .enter()
          .append("circle")
          .attr("class", "bubble")
          .attr("cx", function (d) {
            return x(d.total_wealth)
          })
          .attr("cy", function (d) {
            return y(d.average_life_expectancy)
          })
          .attr("r", function (d) {
            return z(d.population)
          })
          .style("fill", function (d) {
            return color(d.continent)
          })
          .style("fill-opacity", 0.7)

        // 添加X轴和Y轴
        svg
          .append("g")
          .attr("transform", "translate(0," + height + ")")
          .call(d3.axisBottom(x).tickSize(-height))

        svg.append("g").call(d3.axisLeft(y).ticks(10).tickSize(-width))

        // 添加悬浮提示
        var tooltip = d3.select(".tooltip")
        svg
          .selectAll(".bubble")
          .on("mouseover", function (event, d) {
            tooltip
              .style("visibility", "visible")
              .text(
                d.country +
                  ": Billionaires(Num) " +
                  d.billionaires +
                  ", Total Wealth:" +
                  d.total_wealth
              )
          })
          .on("mousemove", function (event, d) {
            tooltip
              .style("top", event.pageY - 10 + "px")
              .style("left", event.pageX + 10 + "px")
          })
          .on("mouseout", function () {
            tooltip.style("visibility", "hidden")
          })
      })()
    </script>
  </body>
</html>
